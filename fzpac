#!/bin/bash

readonly THIS_CMD="${0##*/}"
readonly VERSION='1.0.2'

_help() {
	cat <<EOF
$THIS_CMD -- Arch Linux package finder with fzf

USAGE
    $THIS_CMD SUBCMD KEYWORDS...

SUBCMD
    s, select        Search for and select all available packages.
                     * pacman -Ssq -> fzf
    q, select-local  Search for and select installed packages.
                     * pacman -Qsq -> fzf

    i, info          Search for all available packages,
                     and show detail information that you selected.
                     * pacman -Ssq -> fzf -> pacman -Sii
    l, info-local    Same as [info], but searches for installed packages.
                     instead of all available packages.
                     * pacman -Qsq -> fzf -> pacman -Qil

    p, view          Search for all available packages,
                     and browse the details of the selected one using less pager.
                     * pacman -Ssq -> fzf <--> pacman -Sii|less
    v, view-local    Savem as [view], but searches for installed packages
                     instead of all available packages.
                     * pacman -Qsq -> fzf <--> pacman -Qil|less

    S, install       Select packages and install that you selected.
                     * pacman -Ssq -> fzf -> sudo pacman -S
    R, remove        Select packages and uninstall that you selected.
                     * pacman -Qsq -> fzf -> sudo pacman -Rn

    h, help          Show this usage.
    V, version       Show version.
EOF
}

_test_fzf() {
    if ! command -v fzf &>/dev/null; then
        _err "fzf is not installed. please install it." 
        return 1
    fi
}

_version() {
	echo "$THIS_CMD -- Version $VERSION"
}

_main() {
	if [[ $# -lt 1 ]]; then
		_help
		exit 0
	fi

    _test_fzf || return 1

	for arg in "$@"; do
		case "$arg" in
		s | select)
			shift
			_select_available_pkgs "$@"
			break
			;;
		q | select-local)
			shift
			_select_local_pkgs "$@"
			break
			;;
		i | info)
			shift
			_select_available_pkgs "$@" | pacman -Sii -
			break
			;;
		l | info-local)
			shift
			_select_local_pkgs "$@" | pacman -Qii -
			break
			;;
		p | view)
			shift
			_view_available_pkgs "$@"
			break
			;;
		v | view-local)
			shift
			_view_local_pkgs "$@"
			break
			;;
		S | install)
			shift
			_select_available_pkgs "$@" | sudo pacman -S -
			break
			;;
		R | remove)
			shift
			_select_local_pkgs "$@" | sudo pacman -Rn -
			break
			;;
		h | -h | help | --help)
			_help
			break
			;;
		V | version | --version)
			_version
			break
			;;
		*)
			_err "Invalid sub command: $1."
			_help
			return 1
			;;
		esac
	done
}

_err() {
	echo -e "[ \e[31mERR\e[m ] $*" >&2
}

_select_available_pkgs() {
	pacman -Ssq "$@" |
		fzf --multi --preview 'pacman -Si {}'
}

_select_local_pkgs() {
	pacman -Qsq "$@" |
		fzf --multi --preview 'pacman -Qil {}'
}

_view_available_pkgs() {
	pacman -Ssq "$@" |
		fzf --preview 'pacman -Si {}' --bind 'enter:execute(pacman -Sii {} | less)'
}

_view_local_pkgs() {
	pacman -Qsq "$@" |
		fzf --preview 'pacman -Qil {}' --bind 'enter:execute(pacman -Qil {} | less)'
}

_main "$@"
exit $?
